{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/Packaging-a-Scala-CLI-app-in-2022/Packaging-a-Scala-CLI-app-in-2022/",
    "result": {"data":{"site":{"siteMetadata":{"title":"James Santucci's development blog"}},"markdownRemark":{"id":"15d39c54-d606-5b57-9912-aa716b2f8de9","excerpt":"In past work projects, when I’ve been on a team needing a way to package a Scala application,\nI’ve relied on .  is great\nfor what it’s for — it bundles up…","html":"<p>In past work projects, when I’ve been on a team needing a way to package a Scala application,\nI’ve relied on <a href=\"https://github.com/sbt/sbt-assembly\"><code class=\"language-text\">sbt-assembly</code></a>. <code class=\"language-text\">sbt-assembly</code> is great\nfor what it’s for — it bundles up dependencies and application code in a single fat\n<code class=\"language-text\">jar</code> file, and you can run it anywhere with a Java runtime (subject to all the normal caveats\nabout Java versions).</p>\n<p>That’s great, but more recently, support for bundling Scala apps in other ways has flourished.\n<a href=\"https://scala-native.readthedocs.io/en/latest/#\"><code class=\"language-text\">scala-native</code></a> targets generic POSIX environments,\n<a href=\"https://www.scala-js.org/\">Scala.js</a> targets the browser and hit 1.0 in 2020, and GraalVM provides\nan alternate Java runtime environment\n<a href=\"https://www.graalvm.org/22.1/docs/getting-started/\">“designed to accelerate the execution of applications written in […] JVM languages.”</a>.</p>\n<p>Each of those is developed enough\nto have its own sbt plugin. Partly because I wanted the tool, and partly because I wanted to play\naround with new application bundling options, I used GraalVM and Scala.js to bundle up a CLI\napp for adding rainbow brackets to streaming input.</p>\n<h2>Rainbow brackets</h2>\n<p>Rainbow brackets are great. No one has ever looked at an editor with a rainbow bracket plugin enabled and said\n“you know what, too much syntactical info in the bracket colors for me.” However! Not everyone has access to rainbow\nbrackets everywhere they could. You while Looking at Source Code probably feels an ineffable unease when looking\nat monochrome source code. You while Looking at Logs and Waxing Inexplicably French is probably like\n“ehhhh it’s an inscrutable mass, que sera sera.”</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a9ce71d604b203db765cbbf16c6d6eea/8bf8a/log-output.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.734177215189874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACbUlEQVQozwFiAp39APv6+f78/Pv8/f39/f7+/vz8/P7//vv7+/v7+/////7+/v////7+/v39/f////////7+/v7+///9+9Lk+wDh4uLr7OvJzdDm6OnZ2dj6+vrf3tn8/Pzg2t7i4eHf39/o6Onj4+Py8vLg39/g4OD9/fzl5ufr6+ze3NsAgXB7a1Rkc1xsmJidfH6CgYGFkZKUkJCWdXV7hoiLpaWpnZ6hlpaVn5+fiYqKUlNTh4eHfn19YWFeWlpaAFg+TioEHkYjPWNgZj8+RCwrMVlaX0JETxkeKDxBSWNja0tMUkREQ0BAQENDRAAAADM0NT09PB0ZEBwbGwDBvL+8tLrFv8TU1NXKysrNzc7Y2NnKzM26u7zFxcfe3t7T09HR0tHp6enNzMq3trTNzcy7u7yurq2tra0ANTc3ISIhISIhXF1dNzcyGxoZOjo6TExNICAgIyMjUFBOHRwXBgUDYGBgWFVQUU1Hbm1sWlxeMjM0MTExAH19fWNjZFxcXYOFhHFwaFxbWm9vb4GChGJjZG9wcYSEgkpJRTk4N4eHh3d3dWtra46Mimxta7Ozs+Dg4AC/wMC6u7u9vr/Ozc65vb2tsrLBwcG+vr6xrqq1s7DNzs3V2NXS1dLS0tLe3d3n5+bq6unW19igoaWipKgAOzs2Hh4eFxYWU1hYDT09AA8PJyYnW1hQRjkdRzwoWFtXIS4hICsfEA8Qc3N05OPk2tvbwsLEHhgfDg4WALKyr6ioqK2srLm8vJurrJ2mprKzs7y8u7Cwrbm3tMjHx7i4ucHBwcHAwNPT09/f4O7u7+bm6J+eo6KhplbwYHA6y8fhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"what is this garbage\"\n        title=\"what is this garbage\"\n        src=\"/static/a9ce71d604b203db765cbbf16c6d6eea/f058b/log-output.png\"\n        srcset=\"/static/a9ce71d604b203db765cbbf16c6d6eea/c26ae/log-output.png 158w,\n/static/a9ce71d604b203db765cbbf16c6d6eea/6bdcf/log-output.png 315w,\n/static/a9ce71d604b203db765cbbf16c6d6eea/f058b/log-output.png 630w,\n/static/a9ce71d604b203db765cbbf16c6d6eea/40601/log-output.png 945w,\n/static/a9ce71d604b203db765cbbf16c6d6eea/78612/log-output.png 1260w,\n/static/a9ce71d604b203db765cbbf16c6d6eea/8bf8a/log-output.png 1901w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>But there’s another way! It turns out matching parentheses problems are not very difficult puzzles.\nIf you desire in your heart of hearts to have special colors for brackets, parentheses, and braces that\nhappen to complete each other… you don’t need to suffer in vain, or something.</p>\n<h2>The code</h2>\n<p>Algorithmically, the CLI is <em>really simple</em>. For some streaming input, if you see a character that opens a\npair like <code class=\"language-text\">[</code>, <code class=\"language-text\">(</code>, or <code class=\"language-text\">{</code>, rewrite it to a special colorized version of that same character and push to a stack.\nIf you see a character that closes a pair like <code class=\"language-text\">]</code>, <code class=\"language-text\">)</code>, or <code class=\"language-text\">}</code>, rewrite it to a special colorized version of that\nsame character and pop off a stack.</p>\n<p>We have a few fancy options here. I was inspired by Michael Pilquist’s <a href=\"https://github.com/scodec/hexdump4s\"><code class=\"language-text\">hexdump4s</code></a>\nand got excited about functional abstractions and <em>doing the right thing</em>™️. I wanted to model the state of the parentheses\ncounter using either a <code class=\"language-text\">Ref</code> or a <code class=\"language-text\">StateT[Stream[F, *], Color, *]</code>. Fancy values! It turns out I didn’t need fancy values.\nI enthusiastically stole the <a href=\"https://github.com/scodec/hexdump4s/blob/89271648d5d3d325557562df15c32ad6609a8f2b/hexdump4s.scala#L20-L43\">“file path or stdin” handling from <code class=\"language-text\">hexdump4s</code></a>, then tracked the state of the color wheel\nusing a very unsafe, privately immutable <a href=\"https://github.com/jisantuc/rb-paren-cli/blob/v0.0.1/src/main/scala/io/github/jisantuc/rbparencli/Ring.scala\"><code class=\"language-text\">Ring</code></a>\n<code class=\"language-text\">trait</code>. It tracks a collection of values with size <code class=\"language-text\">n</code> against an index modulo an internal counter.</p>\n<p>With the <code class=\"language-text\">Ring</code> in hand, it was pretty straightforward to handle the rest. <a href=\"https://github.com/bkirwi/decline\"><code class=\"language-text\">decline</code></a> is wonderful\nfor config / command line argument parsing, <a href=\"https://github.com/typelevel/fs2\"><code class=\"language-text\">fs2</code></a> is the GOAT for constant memory IO,\nand <a href=\"https://github.com/typelevel/cats-parse\"><code class=\"language-text\">cats-parse</code></a> is simple and nice for defining shapes of custom string formats\non the fly. The <code class=\"language-text\">decline</code> + <code class=\"language-text\">cats-parse</code> combo was great for defining the shapes of my color arguments. Since CLIs have to deal with horrible string formats all the time, it was great to be able to concissely represent the rules for <em>good</em> strings and hook that into argument parsing.\nNote that once we’re in application logic, everything is purely in domain types —\nthe function responsible for transforming input is <a href=\"https://github.com/jisantuc/rb-paren-cli/blob/v0.0.1/src/main/scala/io/github/jisantuc/rbparencli/Main.scala#L21-L39\"><code class=\"language-text\">colorize</code></a>, and it knows nothing of effects or streaming or arguments, just “if you can give me a palette\nand a character, I can color that character.”</p>\n<p>The end result looks like this:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 472px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f6f6352f508b161f5c610424aede82c1/3c5de/rainbow-parens.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAA7CAAAOwgEVKEqAAAAAcklEQVQI102I7QqCMAAAff+HG0opOQ2d23St/IBmP1pw0SDwx3HHZbrPaRrBtRUYlbN6yeJrRlPibMVzbrmNVXqLl7y2jvUumUxJ3xVodcIO5+SHu5BtXmC9YnI1YS6Iu+azD7yDSv4RgyKGIfF/R+Khv15MlGpdZ+DKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Colored log output, with matching parentheses, brackets, and braces colored\"\n        title=\"Colored log output, with matching parentheses, brackets, and braces colored\"\n        src=\"/static/f6f6352f508b161f5c610424aede82c1/3c5de/rainbow-parens.png\"\n        srcset=\"/static/f6f6352f508b161f5c610424aede82c1/c26ae/rainbow-parens.png 158w,\n/static/f6f6352f508b161f5c610424aede82c1/6bdcf/rainbow-parens.png 315w,\n/static/f6f6352f508b161f5c610424aede82c1/3c5de/rainbow-parens.png 472w\"\n        sizes=\"(max-width: 472px) 100vw, 472px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>So that’s the pinnacle of side project completion — <em>it runs on my machine for toy inputs</em>.</p>\n<h2>Bundling for linux</h2>\n<p>But there are <em>other</em> machines [citation needed], and it’s possible that someone who doesn’t want to learn\nhow to use <code class=\"language-text\">sbt</code> might want rainbow brackets for their log output. No one has asked me for this, but it’s technically\npossible.</p>\n<p>I used <a href=\"https://github.com/sbt/sbt-native-packager\"><code class=\"language-text\">sbt-native-packager</code></a> as the packaging plugin, but instead\nof following the GraalVM JVM setup guides, I fired up a <code class=\"language-text\">nix repl</code>, loaded up <code class=\"language-text\">nixpkgs</code>, crossed my fingers,\nand pressed <code class=\"language-text\">&lt;TAB></code> a few times after typing <code class=\"language-text\">graal</code>. There was a package available (<code class=\"language-text\">graalvm-11-ce</code>) so I added it to <code class=\"language-text\">flake.nix</code>,\n, and gave packaging the app up a try.</p>\n<p>Cross-project configuration for packaging the app was embarrassingly easy:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">lazy</span> <span class=\"token keyword\">val</span> rootJVM <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>jvm\n  <span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">(</span>\n    graalVMNativeImageOptions <span class=\"token operator\">++</span><span class=\"token operator\">=</span> Seq<span class=\"token punctuation\">(</span>\n      <span class=\"token comment\">// prevents image creation and prints more output when bundling</span>\n      <span class=\"token comment\">// is *waves hands* incomplete</span>\n      <span class=\"token string\">\"--no-fallback\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// creates basically a fat jar instead of a binary that requires</span>\n      <span class=\"token comment\">// path / classpath information to execute</span>\n      <span class=\"token string\">\"--static\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// provides nicer logging output when exceptions are encountered</span>\n      <span class=\"token string\">\"-H:+ReportExceptionStackTraces\"</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    GraalVMNativeImage <span class=\"token operator\">/</span> name <span class=\"token operator\">:</span><span class=\"token operator\">=</span> <span class=\"token string\">\"rainbow-parens\"</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span>enablePlugins<span class=\"token punctuation\">(</span>GraalVMNativeImagePlugin<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The <code class=\"language-text\">--static</code> option was really important; it was the difference between being able to run the\nCLI if I copied it somewhere else on my machine and not being able to run it. However, that’s…\nnot very many options to specify. If I compare it to common <code class=\"language-text\">sbt-assembly</code> options at least,\nit’s <a href=\"https://github.com/raster-foundry/raster-foundry/blob/1.70.1/build.sbt#L126-L136\">fewer lines and less cryptic</a>\nthan what I’ve wound up with working on other projects.</p>\n<h2>Bundling for MacOS</h2>\n<p>MacOS is very special and required special handling. <a href=\"https://www.graalvm.org/22.1/docs/getting-started/macos/\">In principle</a>\nit should be possible to set up GraalVM packaging on MacOS, but I don’t really know anything\nabout GraalVM or MacOS, so…</p>\n<p><img src=\"https://media.giphy.com/media/xDQ3Oql1BN54c/giphy.gif\" alt=\"A very good dog floating around a space station\"></p>\n<p>But there’s another option! <code class=\"language-text\">Scala.js</code> cross-project setups are pretty well ironed out, and all of my dependencies\nare cross-published for <code class=\"language-text\">Scala.js</code>, so here’s all I had to do to bundle up a nice <code class=\"language-text\">node.js</code> script:</p>\n<div class=\"gatsby-highlight\" data-language=\"scala\"><pre class=\"language-scala\"><code class=\"language-scala\"><span class=\"token keyword\">lazy</span> <span class=\"token keyword\">val</span> root <span class=\"token operator\">=</span>\n  <span class=\"token punctuation\">(</span>crossProject<span class=\"token punctuation\">(</span>JSPlatform<span class=\"token punctuation\">,</span> JVMPlatform<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>crossType<span class=\"token punctuation\">(</span>CrossType<span class=\"token punctuation\">.</span>Pure<span class=\"token punctuation\">)</span> in file<span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>settings<span class=\"token punctuation\">(</span>settings<span class=\"token operator\">:</span> _<span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>jsSettings<span class=\"token punctuation\">(</span>\n      scalaJSUseMainModuleInitializer <span class=\"token operator\">:</span><span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      scalaJSLinkerConfig <span class=\"token operator\">~</span><span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> _<span class=\"token punctuation\">.</span>withModuleKind<span class=\"token punctuation\">(</span>ModuleKind<span class=\"token punctuation\">.</span>CommonJSModule<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      Compile <span class=\"token operator\">/</span> fullOptJS <span class=\"token operator\">/</span> artifactPath <span class=\"token operator\">:</span><span class=\"token operator\">=</span> baseDirectory<span class=\"token punctuation\">.</span>value <span class=\"token operator\">/</span> <span class=\"token string\">\"rainbow-parens.js\"</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>MacOS users have a little more work to do to make sure they can use <code class=\"language-text\">rainbow-parens</code> as a CLI,\nbut <a href=\"https://github.com/jisantuc/rb-paren-cli#nodejs-script\">not much more work</a>.</p>\n<h2>Release and publication</h2>\n<p>Because Node.js is basically universal, I didn’t have to split the release workflow. Also,\nbecause I have a <code class=\"language-text\">nix</code> shell available, I don’t have to do much in terms of dependency setup in CI —\ninstead I can set up <code class=\"language-text\">nix</code> and let it handle making sure I have everything I need.\nThe bundling step <a href=\"https://github.com/jisantuc/rb-paren-cli/blob/main/.github/workflows/release.yml#L18-L25\">invokes <code class=\"language-text\">sbt</code> commands in a <code class=\"language-text\">nix</code> shell</a>\nthen points a <a href=\"https://github.com/ncipollo/release-action\">release action</a> at the artifacts.\nAnd we’re done!</p>\n<p>This experiment was also a bit inspired by @hillelogram’s <a href=\"https://twitter.com/hillelogram/status/1514352882807721984\">mise en place</a> —\nthe application here is <em>really simple</em>, so it was fine to take a little more technical risk with the release\ntooling. And it worked really well! “Always mise en place” is a good kitchen rule, and it\nturns out to work well for taking risk out of future technical choices too.</p>","frontmatter":{"title":"Packaging a Scala CLI app in 2022","date":"July 17, 2022","description":"Once upon a time sbt-assembly was the best game in town. Now GraalVM and Node.js are viable bundling alternatives."}},"previous":{"fields":{"slug":"/cliffs,-a-small-CLI-for-remembering-what-your-scripts-to-rule-them-all-are-for/cliffs,-a-small-CLI-for-remembering-what-your-scripts-to-rule-them-all-are-for/"},"frontmatter":{"title":"cliffs, a small CLI for remembering what your scripts to rule them all are for"}},"next":{"fields":{"slug":"/Let-Janja-Garnbret-cook/Let-Janja-Garnbret-cook/"},"frontmatter":{"title":"Let Janja cook"}}},"pageContext":{"id":"15d39c54-d606-5b57-9912-aa716b2f8de9","previousPostId":"044a9b46-a101-5f62-bec6-2ef78c2bd4c3","nextPostId":"eb390ad3-006a-56e1-b18d-085b9feb3841"}},
    "staticQueryHashes": ["2841359383","3257411868"]}